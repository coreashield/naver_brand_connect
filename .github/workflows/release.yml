name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.3.0)'
        required: true

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version from tag
        id: get_version
        shell: bash
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create package directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "package"
          New-Item -ItemType Directory -Force -Path "package/node"
          New-Item -ItemType Directory -Force -Path "package/browsers"

      - name: Download Portable Node.js
        shell: pwsh
        run: |
          $nodeVersion = "20.11.0"
          $nodeUrl = "https://nodejs.org/dist/v$nodeVersion/node-v$nodeVersion-win-x64.zip"
          Write-Host "Downloading Node.js $nodeVersion..."
          Invoke-WebRequest -Uri $nodeUrl -OutFile "node.zip"
          Expand-Archive -Path "node.zip" -DestinationPath "temp_node"
          Move-Item -Path "temp_node/node-v$nodeVersion-win-x64/*" -Destination "package/node/"
          Remove-Item -Recurse -Force "temp_node", "node.zip"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        shell: pwsh
        run: |
          $env:PLAYWRIGHT_BROWSERS_PATH = "$PWD/package/browsers"
          npx playwright install chromium

      - name: Copy source files
        shell: pwsh
        run: |
          $include = @("src","app.js","cafe_writer.js","full_sync.js","full_sync_supabase.js","auto_link_issuer.js","package.json","package-lock.json","version.json","update_script.js","INSTALL.bat","자동글쓰기.bat","카페글쓰기.bat","블로그글쓰기.bat","상품정보업데이트.bat")
          foreach ($item in $include) {
            if (Test-Path $item) {
              if ((Get-Item $item).PSIsContainer) {
                Copy-Item -Path $item -Destination "package/$item" -Recurse
              } else {
                Copy-Item -Path $item -Destination "package/$item"
              }
              Write-Host "Copied: $item"
            }
          }
          Copy-Item -Path "node_modules" -Destination "package/node_modules" -Recurse
          New-Item -ItemType Directory -Force -Path "package/output"
          $envContent = "SUPABASE_URL=https://your-project.supabase.co`nSUPABASE_SERVICE_KEY=your-key`nGEMINI_API_KEY=your-key`nACCOUNT_ID=1`nWORKER_NAME=worker-1`nHEADLESS=false"
          $envContent | Out-File -FilePath "package/.env.example" -Encoding UTF8

      - name: Create batch files
        shell: pwsh
        run: |
          $sync = "@echo off`ncd /d `"%~dp0`"`nset PATH=%~dp0node;%PATH%`nset PLAYWRIGHT_BROWSERS_PATH=%~dp0browsers`nnode full_sync_supabase.js`npause"
          $sync | Out-File -FilePath "package/START_SYNC.bat" -Encoding ASCII
          $update = "@echo off`nchcp 65001 >nul`ncd /d `"%~dp0`"`nset PATH=%~dp0node;%PATH%`nnode update_script.js`npause"
          $update | Out-File -FilePath "package/UPDATE.bat" -Encoding ASCII

      - name: Create ZIP package
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $zipName = "shopping_connect_$version.zip"
          Compress-Archive -Path "package/*" -DestinationPath $zipName
          if (Test-Path $zipName) {
            $size = (Get-Item $zipName).Length / 1MB
            Write-Host "Package created: $zipName ($([math]::Round($size, 2)) MB)"
          } else {
            Write-Host "ERROR: ZIP file not created!"
            exit 1
          }

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: shopping_connect_${{ steps.get_version.outputs.VERSION }}.zip
          name: Release ${{ steps.get_version.outputs.VERSION }}
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Shopping Connect ${{ steps.get_version.outputs.VERSION }}

            ### 설치 방법
            1. ZIP 다운로드 후 압축 해제
            2. .env.example을 .env로 복사 후 설정
            3. 자동글쓰기.bat 실행

            ### 포함 배치파일
            - 자동글쓰기.bat (카페+블로그 자동)
            - 카페글쓰기.bat
            - 블로그글쓰기.bat
            - 상품정보업데이트.bat

            ### 포함 내용
            - Portable Node.js 20.11.0
            - Chromium Browser
            - 모든 소스코드 및 의존성
          draft: false
          prerelease: false
