<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë„¤ì´ë²„ ê³„ì • ê´€ë¦¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .card h2 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    /* í¼ */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .form-group input {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-danger { background: #ff4757; color: white; }
    .btn-danger:hover { background: #ff3344; }
    .btn-success { background: #2ed573; color: white; }
    .btn-warning { background: #ffa502; color: white; }
    .btn-sm { padding: 4px 8px; font-size: 11px; }

    /* í…Œì´ë¸” */
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; white-space: nowrap; }
    th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; }
    th { background: #f8f9fa; font-weight: 600; color: #333; }
    tr:hover { background: #f8f9fa; }
    td:nth-child(5) { min-width: 80px; } /* ì¹´í˜ */
    td:nth-child(9) { max-width: 80px; overflow: hidden; text-overflow: ellipsis; } /* ë©”ëª¨ */

    .status-active { color: #2ed573; font-weight: bold; }
    .status-suspended { color: #ff4757; font-weight: bold; }
    .actions { display: flex; gap: 3px; }

    /* í†µê³„ */
    .stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      min-width: 150px;
      text-align: center;
    }
    .stat-box .number { font-size: 32px; font-weight: bold; }
    .stat-box .label { font-size: 14px; opacity: 0.9; }

    /* ì•Œë¦¼ */
    .alert { padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none; }
    .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

    .pw-cell { font-family: monospace; cursor: pointer; }
    .pw-cell:hover { color: #667eea; }
    .loading { text-align: center; padding: 40px; color: #666; }

    .count-cell { cursor: pointer; transition: all 0.2s; padding: 2px 4px; border-radius: 4px; }
    .count-cell:hover { background: #e8f0fe; color: #667eea; }
    .alias-cell { cursor: pointer; transition: all 0.2s; padding: 2px 4px; border-radius: 4px; color: #667eea; }
    .alias-cell:hover { background: #e8f0fe; text-decoration: underline; }
    .id-cell { cursor: pointer; transition: all 0.2s; padding: 2px 4px; border-radius: 4px; font-weight: bold; color: #333; }
    .id-cell:hover { background: #fff3cd; color: #856404; }
    .editing-row { background: #fff3cd !important; }
    .card.edit-mode { border: 3px solid #ffa502; }
    .card.edit-mode h2 { color: #ffa502; }
    .count-cell input {
      width: 40px;
      padding: 2px;
      border: 2px solid #667eea;
      border-radius: 4px;
      font-size: 12px;
      text-align: center;
    }

    @media (max-width: 768px) {
      .form-grid { grid-template-columns: 1fr; }
      .stats { justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” ë„¤ì´ë²„ ê³„ì • ê´€ë¦¬</h1>

    <!-- í†µê³„ -->
    <div class="stats">
      <div class="stat-box">
        <div class="number" id="totalAccounts">-</div>
        <div class="label">ì „ì²´ ê³„ì •</div>
      </div>
      <div class="stat-box" style="background: linear-gradient(135deg, #2ed573 0%, #1e90ff 100%);">
        <div class="number" id="activeAccounts">-</div>
        <div class="label">í™œì„± ê³„ì •</div>
      </div>
      <div class="stat-box" style="background: linear-gradient(135deg, #ffa502 0%, #ff6348 100%);">
        <div class="number" id="todayCafePosts">-</div>
        <div class="label">ì˜¤ëŠ˜ ì¹´í˜ í¬ìŠ¤íŒ…</div>
      </div>
      <div class="stat-box" style="background: linear-gradient(135deg, #ff4757 0%, #c44569 100%);">
        <div class="number" id="todayBlogPosts">-</div>
        <div class="label">ì˜¤ëŠ˜ ë¸”ë¡œê·¸ í¬ìŠ¤íŒ…</div>
      </div>
    </div>

    <!-- ê³„ì • ì¶”ê°€/ìˆ˜ì • -->
    <div class="card" id="formCard">
      <h2 id="formTitle">â• ìƒˆ ê³„ì • ì¶”ê°€</h2>
      <div id="alertAdd" class="alert"></div>
      <input type="hidden" id="editingId" value="">
      <div class="form-grid">
        <div class="form-group">
          <label>ë„¤ì´ë²„ ID *</label>
          <input type="text" id="naverId" placeholder="example123">
        </div>
        <div class="form-group">
          <label>ë¹„ë°€ë²ˆí˜¸ *</label>
          <input type="password" id="naverPw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <div class="form-group">
          <label>ë¸”ë¡œê·¸ ID</label>
          <input type="text" id="blogId" placeholder="ë„¤ì´ë²„ IDì™€ ë™ì¼ ì‹œ ë¹„ì›Œë‘ì„¸ìš”">
        </div>
        <div class="form-group">
          <label>ì¹´í˜ ê¸€ì“°ê¸° URL</label>
          <input type="text" id="cafeUrl" placeholder="https://cafe.naver.com/ca-fe/cafes/.../articles/write">
        </div>
        <div class="form-group">
          <label>ì¹´í˜ ë³„ì¹­ (ê°€ì…ìš©)</label>
          <input type="text" id="cafeAlias" placeholder="todaydeuktem">
        </div>
        <div class="form-group">
          <label>ì¼ì¼ ì¹´í˜ ì œí•œ</label>
          <input type="number" id="dailyCafeLimit" value="150">
        </div>
        <div class="form-group">
          <label>ì¼ì¼ ë¸”ë¡œê·¸ ì œí•œ</label>
          <input type="number" id="dailyBlogLimit" value="5">
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label>ë©”ëª¨</label>
          <input type="text" id="memo" placeholder="ê³„ì •ì— ëŒ€í•œ ë©”ëª¨">
        </div>
      </div>
      <div id="formButtons">
        <button class="btn btn-primary" id="btnAdd" onclick="addAccount()">ê³„ì • ì¶”ê°€</button>
        <button class="btn btn-success" id="btnUpdate" onclick="updateAccount()" style="display:none;">ìˆ˜ì • ì €ì¥</button>
        <button class="btn btn-primary" id="btnSaveNew" onclick="saveAsNew()" style="display:none;">ìƒˆë¡œ ì €ì¥</button>
        <button class="btn btn-danger" id="btnCancel" onclick="cancelEdit()" style="display:none;">ì·¨ì†Œ</button>
      </div>
    </div>

    <!-- ê³„ì • ëª©ë¡ -->
    <div class="card">
      <h2>ğŸ“‹ ê³„ì • ëª©ë¡ <button class="btn btn-sm" onclick="loadAccounts()" style="margin-left:10px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button></h2>
      <div id="alertList" class="alert"></div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>ë„¤ì´ë²„ID</th>
              <th>ë¹„ë°€ë²ˆí˜¸</th>
              <th>ë¸”ë¡œê·¸ID</th>
              <th>ì¹´í˜ë³„ì¹­</th>
              <th>ì¹´í˜URL</th>
              <th style="text-align:center;">âš¡</th>
              <th>ì¹´í˜ê¸€</th>
              <th>ë¸”ë¡œê·¸ê¸€</th>
              <th>ìµœê·¼ ë¦¬ì…‹</th>
              <th>ë©”ëª¨</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="accountsTable">
            <tr><td colspan="12" class="loading">ë¡œë”© ì¤‘...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê³„ì • ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', loadAccounts);

    // ë¦¬ì…‹ ë‚ ì§œ í¬ë§·
    function formatResetDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      const now = new Date();
      const isToday = date.toDateString() === now.toDateString();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const mins = String(date.getMinutes()).padStart(2, '0');
      if (isToday) {
        return `ì˜¤ëŠ˜ ${hours}:${mins}`;
      }
      return `${month}/${day} ${hours}:${mins}`;
    }

    // í´ë¦½ë³´ë“œ ë³µì‚¬
    function copyToClipboard(text) {
      if (!text || text === '-') return;
      navigator.clipboard.writeText(text).then(() => {
        showAlert('alertList', 'success', 'ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
      });
    }

    // ê³„ì • ëª©ë¡ ë¡œë“œ
    async function loadAccounts() {
      const tbody = document.getElementById('accountsTable');
      tbody.innerHTML = '<tr><td colspan="12" class="loading">ë¡œë”© ì¤‘...</td></tr>';

      try {
        const res = await fetch('/api/accounts');
        const result = await res.json();

        if (!result.success) throw new Error(result.error);

        const data = result.data;
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="12" class="loading">ë“±ë¡ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          updateStats([]);
          return;
        }

        tbody.innerHTML = data.map(acc => `
          <tr data-id="${acc.id}">
            <td>${acc.id}</td>
            <td class="id-cell" onclick="loadAccountToForm(${acc.id})" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •">${acc.naver_id}</td>
            <td class="pw-cell" onclick="copyToClipboard('${acc.naver_pw}')" title="í´ë¦­í•˜ì—¬ ë³µì‚¬">${acc.naver_pw}</td>
            <td>${acc.blog_id || '-'}</td>
            <td class="alias-cell" onclick="goToCafe('${acc.cafe_alias || ''}')" title="í´ë¦­í•˜ì—¬ ì¹´í˜ ì´ë™">${acc.cafe_alias || '-'}</td>
            <td style="max-width:180px; overflow:hidden; text-overflow:ellipsis; cursor:pointer;" onclick="copyToClipboard('${acc.cafe_url || ''}')" title="í´ë¦­í•˜ì—¬ ë³µì‚¬">${acc.cafe_url ? '...' + acc.cafe_url.slice(-30) : '-'}</td>
            <td style="text-align:center;">${acc.status === 'active' ? 'âœ…' : 'â›”'}</td>
            <td>
              <span class="count-cell" onclick="editCount(this, ${acc.id}, 'today_cafe_count', ${acc.today_cafe_count})" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •">
                ${acc.today_cafe_count}
              </span> / <span class="count-cell" onclick="editCount(this, ${acc.id}, 'daily_cafe_limit', ${acc.daily_cafe_limit})" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •">
                ${acc.daily_cafe_limit}
              </span>
            </td>
            <td>
              <span class="count-cell" onclick="editCount(this, ${acc.id}, 'today_blog_count', ${acc.today_blog_count})" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •">
                ${acc.today_blog_count}
              </span> / <span class="count-cell" onclick="editCount(this, ${acc.id}, 'daily_blog_limit', ${acc.daily_blog_limit})" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •">
                ${acc.daily_blog_limit}
              </span>
            </td>
            <td style="font-size:11px; color:#666;">${formatResetDate(acc.last_reset_date)}</td>
            <td>${acc.memo || '-'}</td>
            <td class="actions">
              ${acc.status === 'active'
                ? `<button class="btn btn-warning btn-sm" onclick="toggleStatus(${acc.id}, 'suspended')">ì¤‘ì§€</button>`
                : `<button class="btn btn-success btn-sm" onclick="toggleStatus(${acc.id}, 'active')">í™œì„±</button>`
              }
              <button class="btn btn-danger btn-sm" onclick="deleteAccount(${acc.id}, '${acc.naver_id}')">ì‚­ì œ</button>
            </td>
          </tr>
        `).join('');

        // ê³„ì • ë°ì´í„° ì €ì¥ (ìˆ˜ì •ìš©)
        window.accountsData = data;

        updateStats(data);

      } catch (err) {
        showAlert('alertList', 'error', 'ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
        tbody.innerHTML = '<tr><td colspan="12" class="loading">ì˜¤ë¥˜ ë°œìƒ</td></tr>';
      }
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats(data) {
      document.getElementById('totalAccounts').textContent = data.length;
      document.getElementById('activeAccounts').textContent = data.filter(a => a.status === 'active').length;
      document.getElementById('todayCafePosts').textContent = data.reduce((sum, a) => sum + (a.today_cafe_count || 0), 0);
      document.getElementById('todayBlogPosts').textContent = data.reduce((sum, a) => sum + (a.today_blog_count || 0), 0);
    }

    // ë¹„ë°€ë²ˆí˜¸ í† ê¸€
    function togglePw(el, pw) {
      el.textContent = el.textContent === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' ? pw : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
    }

    // ê³„ì • ì¶”ê°€
    async function addAccount() {
      const naverId = document.getElementById('naverId').value.trim();
      const naverPw = document.getElementById('naverPw').value.trim();

      if (!naverId || !naverPw) {
        showAlert('alertAdd', 'error', 'IDì™€ ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
      }

      try {
        const res = await fetch('/api/accounts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            naver_id: naverId,
            naver_pw: naverPw,
            blog_id: document.getElementById('blogId').value.trim() || naverId,
            cafe_url: document.getElementById('cafeUrl').value.trim(),
            cafe_alias: document.getElementById('cafeAlias').value.trim(),
            daily_cafe_limit: (v => isNaN(v) ? 150 : v)(parseInt(document.getElementById('dailyCafeLimit').value)),
            daily_blog_limit: (v => isNaN(v) ? 5 : v)(parseInt(document.getElementById('dailyBlogLimit').value)),
            memo: document.getElementById('memo').value.trim()
          })
        });

        const result = await res.json();
        if (!result.success) throw new Error(result.error);

        showAlert('alertAdd', 'success', `âœ… ê³„ì • ë“±ë¡ ì™„ë£Œ! (ID: ${result.data.id})`);

        // í¼ ì´ˆê¸°í™”
        document.getElementById('naverId').value = '';
        document.getElementById('naverPw').value = '';
        document.getElementById('blogId').value = '';
        document.getElementById('cafeUrl').value = '';
        document.getElementById('cafeAlias').value = '';
        document.getElementById('memo').value = '';

        loadAccounts();

      } catch (err) {
        showAlert('alertAdd', 'error', 'ì¶”ê°€ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // ìƒíƒœ ë³€ê²½
    async function toggleStatus(id, newStatus) {
      try {
        const res = await fetch(`/api/accounts/${id}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });

        const result = await res.json();
        if (!result.success) throw new Error(result.error);
        loadAccounts();
      } catch (err) {
        alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // ê³„ì • ì‚­ì œ
    async function deleteAccount(id, naverId) {
      if (!confirm(`ì •ë§ "${naverId}" ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        const res = await fetch(`/api/accounts/${id}`, { method: 'DELETE' });
        const result = await res.json();
        if (!result.success) throw new Error(result.error);
        loadAccounts();
      } catch (err) {
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // ì•Œë¦¼ í‘œì‹œ
    function showAlert(elementId, type, message) {
      const el = document.getElementById(elementId);
      el.className = `alert alert-${type}`;
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 5000);
    }

    // ê²Œì‹œ íšŸìˆ˜ ìˆ˜ì •
    function editCount(el, accountId, type, currentValue) {
      // ì´ë¯¸ inputì´ ìˆìœ¼ë©´ ë¬´ì‹œ
      if (el.querySelector('input')) return;

      const originalValue = currentValue;
      const input = document.createElement('input');
      input.type = 'number';
      input.value = currentValue;
      input.min = 0;
      input.max = 999;
      input.dataset.accountId = accountId;
      input.dataset.type = type;
      input.dataset.originalValue = originalValue;

      el.textContent = '';
      el.appendChild(input);
      input.focus();
      input.select();

      // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      input.addEventListener('blur', handleCountBlur);
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          this.blur();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          this.parentElement.textContent = this.dataset.originalValue;
        }
      });
    }

    // blur í•¸ë“¤ëŸ¬
    async function handleCountBlur(e) {
      const input = e.target;
      const accountId = input.dataset.accountId;
      const field = input.dataset.type;
      const originalValue = input.dataset.originalValue;
      const newValue = parseInt(input.value) || 0;
      const parentEl = input.parentElement;

      // ê°’ì´ ê°™ìœ¼ë©´ ì›ë³µ
      if (newValue == originalValue) {
        parentEl.textContent = originalValue;
        return;
      }

      try {
        const body = { [field]: newValue };

        const res = await fetch(`/api/accounts/${accountId}/counts`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const result = await res.json();
        if (!result.success) throw new Error(result.error);

        // ì„±ê³µ
        parentEl.textContent = newValue;
        const labels = {
          today_cafe_count: 'ì¹´í˜ ê²Œì‹œ íšŸìˆ˜',
          today_blog_count: 'ë¸”ë¡œê·¸ ê²Œì‹œ íšŸìˆ˜',
          daily_cafe_limit: 'ì¹´í˜ ì¼ì¼ ì œí•œ',
          daily_blog_limit: 'ë¸”ë¡œê·¸ ì¼ì¼ ì œí•œ'
        };
        showAlert('alertList', 'success', `âœ… ${labels[field]}ê°€ ${newValue}ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);

        // ë©”ëª¨ë¦¬ ë°ì´í„°ë„ ì—…ë°ì´íŠ¸ (í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨ ì—†ì´)
        if (window.accountsData) {
          const acc = window.accountsData.find(a => a.id == accountId);
          if (acc) {
            acc[field] = newValue;
            // í†µê³„ ë°•ìŠ¤ë„ ì—…ë°ì´íŠ¸
            updateStats(window.accountsData);
          }
        }

      } catch (err) {
        alert('ìˆ˜ì • ì‹¤íŒ¨: ' + err.message);
        parentEl.textContent = originalValue;
      }
    }

    // í…ìŠ¤íŠ¸ í•„ë“œ ìˆ˜ì • (ì¹´í˜ë³„ì¹­ ë“±)
    function editTextField(el, accountId, field, currentValue) {
      if (el.querySelector('input')) return;

      const originalValue = currentValue || '';
      const displayValue = originalValue || '-';
      const input = document.createElement('input');
      input.type = 'text';
      input.value = originalValue;
      input.style.cssText = 'width:100px; padding:2px; border:2px solid #667eea; border-radius:4px; font-size:12px;';
      input.dataset.accountId = accountId;
      input.dataset.field = field;
      input.dataset.originalValue = originalValue;
      input.dataset.displayValue = displayValue;

      el.textContent = '';
      el.appendChild(input);
      input.focus();
      input.select();

      input.addEventListener('blur', handleTextFieldBlur);
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          this.blur();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          this.parentElement.textContent = this.dataset.displayValue;
        }
      });
    }

    // í…ìŠ¤íŠ¸ í•„ë“œ blur í•¸ë“¤ëŸ¬
    async function handleTextFieldBlur(e) {
      const input = e.target;
      const accountId = input.dataset.accountId;
      const field = input.dataset.field;
      const originalValue = input.dataset.originalValue;
      const displayValue = input.dataset.displayValue;
      const newValue = input.value.trim();
      const parentEl = input.parentElement;

      if (newValue === originalValue) {
        parentEl.textContent = displayValue;
        return;
      }

      try {
        const res = await fetch(`/api/accounts/${accountId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [field]: newValue })
        });

        const result = await res.json();
        if (!result.success) throw new Error(result.error);

        parentEl.textContent = newValue || '-';
        const labels = { cafe_alias: 'ì¹´í˜ ë³„ì¹­', cafe_url: 'ì¹´í˜ URL', memo: 'ë©”ëª¨', blog_id: 'ë¸”ë¡œê·¸ ID' };
        showAlert('alertList', 'success', `âœ… ${labels[field] || field}ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);

      } catch (err) {
        alert('ìˆ˜ì • ì‹¤íŒ¨: ' + err.message);
        parentEl.textContent = displayValue;
      }
    }

    // ì¹´í˜ ë§í¬ë¡œ ì´ë™ (í´ë¦­)
    function goToCafe(alias) {
      if (!alias || alias === '-') {
        showAlert('alertList', 'error', 'ì¹´í˜ ë³„ì¹­ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }
      window.open(`https://cafe.naver.com/${alias}`, '_blank');
    }

    // ê³„ì • ì •ë³´ë¥¼ í¼ì— ë¡œë“œ (ìˆ˜ì • ëª¨ë“œ)
    function loadAccountToForm(accountId) {
      const acc = window.accountsData?.find(a => a.id === accountId);
      if (!acc) {
        alert('ê³„ì • ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
      document.getElementById('editingId').value = acc.id;
      document.getElementById('naverId').value = acc.naver_id;
      document.getElementById('naverId').disabled = true; // IDëŠ” ìˆ˜ì • ë¶ˆê°€
      document.getElementById('naverPw').value = acc.naver_pw;
      document.getElementById('blogId').value = acc.blog_id || '';
      document.getElementById('cafeUrl').value = acc.cafe_url || '';
      document.getElementById('cafeAlias').value = acc.cafe_alias || '';
      document.getElementById('dailyCafeLimit').value = acc.daily_cafe_limit ?? 150;
      document.getElementById('dailyBlogLimit').value = acc.daily_blog_limit ?? 5;
      document.getElementById('memo').value = acc.memo || '';

      // UI ë³€ê²½ - ìˆ˜ì • ëª¨ë“œ
      document.getElementById('formTitle').textContent = `âœï¸ ê³„ì • ìˆ˜ì •: ${acc.naver_id}`;
      document.getElementById('formCard').classList.add('edit-mode');
      document.getElementById('btnAdd').style.display = 'none';
      document.getElementById('btnUpdate').style.display = 'inline-block';
      document.getElementById('btnSaveNew').style.display = 'inline-block';
      document.getElementById('btnCancel').style.display = 'inline-block';

      // í…Œì´ë¸”ì—ì„œ í•´ë‹¹ í–‰ í•˜ì´ë¼ì´íŠ¸
      document.querySelectorAll('#accountsTable tr').forEach(tr => tr.classList.remove('editing-row'));
      document.querySelector(`#accountsTable tr[data-id="${accountId}"]`)?.classList.add('editing-row');

      // í¼ìœ¼ë¡œ ìŠ¤í¬ë¡¤
      document.getElementById('formCard').scrollIntoView({ behavior: 'smooth', block: 'start' });

      showAlert('alertAdd', 'success', `ğŸ“ "${acc.naver_id}" ê³„ì • ì •ë³´ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ "ìˆ˜ì • ì €ì¥" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.`);
    }

    // ê³„ì • ìˆ˜ì • ì €ì¥
    async function updateAccount() {
      const editingId = document.getElementById('editingId').value;
      if (!editingId) {
        alert('ìˆ˜ì •í•  ê³„ì •ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }

      const naverPw = document.getElementById('naverPw').value.trim();
      if (!naverPw) {
        showAlert('alertAdd', 'error', 'ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
      }

      try {
        const res = await fetch(`/api/accounts/${editingId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            naver_pw: naverPw,
            blog_id: document.getElementById('blogId').value.trim() || null,
            cafe_url: document.getElementById('cafeUrl').value.trim() || null,
            cafe_alias: document.getElementById('cafeAlias').value.trim() || null,
            daily_cafe_limit: (v => isNaN(v) ? 150 : v)(parseInt(document.getElementById('dailyCafeLimit').value)),
            daily_blog_limit: (v => isNaN(v) ? 5 : v)(parseInt(document.getElementById('dailyBlogLimit').value)),
            memo: document.getElementById('memo').value.trim() || null
          })
        });

        const result = await res.json();
        if (!result.success) throw new Error(result.error);

        showAlert('alertAdd', 'success', 'âœ… ê³„ì • ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
        cancelEdit(); // í¼ ì´ˆê¸°í™”
        loadAccounts(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨

      } catch (err) {
        showAlert('alertAdd', 'error', 'ìˆ˜ì • ì‹¤íŒ¨: ' + err.message);
      }
    }

    // ìˆ˜ì • ì·¨ì†Œ (í¼ ì´ˆê¸°í™”)
    function cancelEdit() {
      document.getElementById('editingId').value = '';
      document.getElementById('naverId').value = '';
      document.getElementById('naverId').disabled = false;
      document.getElementById('naverPw').value = '';
      document.getElementById('blogId').value = '';
      document.getElementById('cafeUrl').value = '';
      document.getElementById('cafeAlias').value = '';
      document.getElementById('dailyCafeLimit').value = '150';
      document.getElementById('dailyBlogLimit').value = '5';
      document.getElementById('memo').value = '';

      // UI ë³€ê²½ - ì¶”ê°€ ëª¨ë“œ
      document.getElementById('formTitle').textContent = 'â• ìƒˆ ê³„ì • ì¶”ê°€';
      document.getElementById('formCard').classList.remove('edit-mode');
      document.getElementById('btnAdd').style.display = 'inline-block';
      document.getElementById('btnUpdate').style.display = 'none';
      document.getElementById('btnSaveNew').style.display = 'none';
      document.getElementById('btnCancel').style.display = 'none';

      // í…Œì´ë¸” í•˜ì´ë¼ì´íŠ¸ ì œê±°
      document.querySelectorAll('#accountsTable tr').forEach(tr => tr.classList.remove('editing-row'));
    }

    // ìƒˆë¡œ ì €ì¥ (ID/ë¹„ë²ˆë§Œ ë°”ê¿”ì„œ ìƒˆ ê³„ì •ìœ¼ë¡œ ì¶”ê°€)
    function saveAsNew() {
      // ID ì…ë ¥ í™œì„±í™” (ê¸°ì¡´ ê°’ ìœ ì§€, ìˆ˜ì • ê°€ëŠ¥)
      document.getElementById('naverId').disabled = false;
      document.getElementById('naverId').focus();
      document.getElementById('naverId').select(); // ì „ì²´ ì„ íƒìœ¼ë¡œ ë°”ë¡œ ìˆ˜ì • ê°€ëŠ¥

      // editingId ì´ˆê¸°í™” (ìƒˆ ê³„ì • ì¶”ê°€ ëª¨ë“œ)
      document.getElementById('editingId').value = '';

      // UI ë³€ê²½
      document.getElementById('formTitle').textContent = 'â• ìƒˆ ê³„ì •ìœ¼ë¡œ ì €ì¥ (ID ìˆ˜ì • í›„ ì¶”ê°€)';
      document.getElementById('formCard').classList.remove('edit-mode');
      document.getElementById('btnUpdate').style.display = 'none';
      document.getElementById('btnSaveNew').style.display = 'none';
      document.getElementById('btnAdd').style.display = 'inline-block';

      // í…Œì´ë¸” í•˜ì´ë¼ì´íŠ¸ ì œê±°
      document.querySelectorAll('#accountsTable tr').forEach(tr => tr.classList.remove('editing-row'));

      showAlert('alertAdd', 'success', 'ğŸ“ IDë¥¼ ìƒˆë¡œìš´ ê°’ìœ¼ë¡œ ë³€ê²½ í›„ "ê³„ì • ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”. (ê°™ì€ IDëŠ” ì¤‘ë³µ ì˜¤ë¥˜)');
    }

    // ì „ì—­ ë…¸ì¶œ
    window.loadAccounts = loadAccounts;
    window.addAccount = addAccount;
    window.toggleStatus = toggleStatus;
    window.deleteAccount = deleteAccount;
    window.togglePw = togglePw;
    window.editCount = editCount;
    window.editTextField = editTextField;
    window.goToCafe = goToCafe;
    window.loadAccountToForm = loadAccountToForm;
    window.updateAccount = updateAccount;
    window.cancelEdit = cancelEdit;
    window.saveAsNew = saveAsNew;
  </script>
</body>
</html>
