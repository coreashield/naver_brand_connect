<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë„¤ì´ë²„ ê³„ì • ê´€ë¦¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .card h2 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    /* í¼ */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .form-group input {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-danger { background: #ff4757; color: white; }
    .btn-danger:hover { background: #ff3344; }
    .btn-success { background: #2ed573; color: white; }
    .btn-warning { background: #ffa502; color: white; }
    .btn-sm { padding: 4px 8px; font-size: 11px; }

    /* í…Œì´ë¸” */
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; white-space: nowrap; }
    th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; }
    th { background: #f8f9fa; font-weight: 600; color: #333; }
    tr:hover { background: #f8f9fa; }
    td:nth-child(5) { min-width: 80px; } /* ì¹´í˜ */
    td:nth-child(9) { max-width: 80px; overflow: hidden; text-overflow: ellipsis; } /* ë©”ëª¨ */

    .status-active { color: #2ed573; font-weight: bold; }
    .status-suspended { color: #ff4757; font-weight: bold; }
    .actions { display: flex; gap: 3px; }

    /* í†µê³„ */
    .stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      min-width: 150px;
      text-align: center;
    }
    .stat-box .number { font-size: 32px; font-weight: bold; }
    .stat-box .label { font-size: 14px; opacity: 0.9; }

    /* ì•Œë¦¼ */
    .alert { padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none; }
    .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

    .pw-cell { font-family: monospace; cursor: pointer; }
    .pw-cell:hover { color: #667eea; }
    .loading { text-align: center; padding: 40px; color: #666; }

    .count-cell { cursor: pointer; transition: all 0.2s; padding: 2px 4px; border-radius: 4px; }
    .count-cell:hover { background: #e8f0fe; color: #667eea; }
    .count-cell input {
      width: 40px;
      padding: 2px;
      border: 2px solid #667eea;
      border-radius: 4px;
      font-size: 12px;
      text-align: center;
    }

    @media (max-width: 768px) {
      .form-grid { grid-template-columns: 1fr; }
      .stats { justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” ë„¤ì´ë²„ ê³„ì • ê´€ë¦¬</h1>

    <!-- í†µê³„ -->
    <div class="stats">
      <div class="stat-box">
        <div class="number" id="totalAccounts">-</div>
        <div class="label">ì „ì²´ ê³„ì •</div>
      </div>
      <div class="stat-box" style="background: linear-gradient(135deg, #2ed573 0%, #1e90ff 100%);">
        <div class="number" id="activeAccounts">-</div>
        <div class="label">í™œì„± ê³„ì •</div>
      </div>
      <div class="stat-box" style="background: linear-gradient(135deg, #ffa502 0%, #ff6348 100%);">
        <div class="number" id="todayCafePosts">-</div>
        <div class="label">ì˜¤ëŠ˜ ì¹´í˜ í¬ìŠ¤íŒ…</div>
      </div>
      <div class="stat-box" style="background: linear-gradient(135deg, #ff4757 0%, #c44569 100%);">
        <div class="number" id="todayBlogPosts">-</div>
        <div class="label">ì˜¤ëŠ˜ ë¸”ë¡œê·¸ í¬ìŠ¤íŒ…</div>
      </div>
    </div>

    <!-- ê³„ì • ì¶”ê°€ -->
    <div class="card">
      <h2>â• ìƒˆ ê³„ì • ì¶”ê°€</h2>
      <div id="alertAdd" class="alert"></div>
      <div class="form-grid">
        <div class="form-group">
          <label>ë„¤ì´ë²„ ID *</label>
          <input type="text" id="naverId" placeholder="example123">
        </div>
        <div class="form-group">
          <label>ë¹„ë°€ë²ˆí˜¸ *</label>
          <input type="password" id="naverPw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <div class="form-group">
          <label>ë¸”ë¡œê·¸ ID</label>
          <input type="text" id="blogId" placeholder="ë„¤ì´ë²„ IDì™€ ë™ì¼ ì‹œ ë¹„ì›Œë‘ì„¸ìš”">
        </div>
        <div class="form-group">
          <label>ì¹´í˜ ê¸€ì“°ê¸° URL</label>
          <input type="text" id="cafeUrl" placeholder="https://cafe.naver.com/...">
        </div>
        <div class="form-group">
          <label>ì¼ì¼ ì¹´í˜ ì œí•œ</label>
          <input type="number" id="dailyCafeLimit" value="150">
        </div>
        <div class="form-group">
          <label>ì¼ì¼ ë¸”ë¡œê·¸ ì œí•œ</label>
          <input type="number" id="dailyBlogLimit" value="5">
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label>ë©”ëª¨</label>
          <input type="text" id="memo" placeholder="ê³„ì •ì— ëŒ€í•œ ë©”ëª¨">
        </div>
      </div>
      <button class="btn btn-primary" onclick="addAccount()">ê³„ì • ì¶”ê°€</button>
    </div>

    <!-- ê³„ì • ëª©ë¡ -->
    <div class="card">
      <h2>ğŸ“‹ ê³„ì • ëª©ë¡ <button class="btn btn-sm" onclick="loadAccounts()" style="margin-left:10px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button></h2>
      <div id="alertList" class="alert"></div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>ë„¤ì´ë²„ID</th>
              <th>ë¹„ë°€ë²ˆí˜¸</th>
              <th>ë¸”ë¡œê·¸ID</th>
              <th>ì¹´í˜</th>
              <th style="text-align:center;">âš¡</th>
              <th>ì¹´í˜ê¸€</th>
              <th>ë¸”ë¡œê·¸ê¸€</th>
              <th>ë©”ëª¨</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="accountsTable">
            <tr><td colspan="10" class="loading">ë¡œë”© ì¤‘...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê³„ì • ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', loadAccounts);

    // í´ë¦½ë³´ë“œ ë³µì‚¬
    function copyToClipboard(text) {
      if (!text || text === '-') return;
      navigator.clipboard.writeText(text).then(() => {
        showAlert('alertList', 'success', 'ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
      });
    }

    // ê³„ì • ëª©ë¡ ë¡œë“œ
    async function loadAccounts() {
      const tbody = document.getElementById('accountsTable');
      tbody.innerHTML = '<tr><td colspan="10" class="loading">ë¡œë”© ì¤‘...</td></tr>';

      try {
        const res = await fetch('/api/accounts');
        const result = await res.json();

        if (!result.success) throw new Error(result.error);

        const data = result.data;
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="10" class="loading">ë“±ë¡ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          updateStats([]);
          return;
        }

        tbody.innerHTML = data.map(acc => `
          <tr>
            <td>${acc.id}</td>
            <td>${acc.naver_id}</td>
            <td class="pw-cell" onclick="togglePw(this, '${acc.naver_pw}')">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</td>
            <td>${acc.blog_id || '-'}</td>
            <td style="max-width:250px; overflow:hidden; text-overflow:ellipsis; cursor:pointer;" onclick="copyToClipboard('${acc.cafe_url || ''}')" title="í´ë¦­í•˜ì—¬ ë³µì‚¬">${acc.cafe_url || '-'}</td>
            <td style="text-align:center;">${acc.status === 'active' ? 'âœ…' : 'â›”'}</td>
            <td>
              <span class="count-cell" onclick="editCount(this, ${acc.id}, 'today_cafe_count', ${acc.today_cafe_count})" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •">
                ${acc.today_cafe_count}
              </span> / <span class="count-cell" onclick="editCount(this, ${acc.id}, 'daily_cafe_limit', ${acc.daily_cafe_limit})" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •">
                ${acc.daily_cafe_limit}
              </span>
            </td>
            <td>
              <span class="count-cell" onclick="editCount(this, ${acc.id}, 'today_blog_count', ${acc.today_blog_count})" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •">
                ${acc.today_blog_count}
              </span> / <span class="count-cell" onclick="editCount(this, ${acc.id}, 'daily_blog_limit', ${acc.daily_blog_limit})" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •">
                ${acc.daily_blog_limit}
              </span>
            </td>
            <td>${acc.memo || '-'}</td>
            <td class="actions">
              ${acc.status === 'active'
                ? `<button class="btn btn-warning btn-sm" onclick="toggleStatus(${acc.id}, 'suspended')">ì¤‘ì§€</button>`
                : `<button class="btn btn-success btn-sm" onclick="toggleStatus(${acc.id}, 'active')">í™œì„±</button>`
              }
              <button class="btn btn-danger btn-sm" onclick="deleteAccount(${acc.id}, '${acc.naver_id}')">ì‚­ì œ</button>
            </td>
          </tr>
        `).join('');

        updateStats(data);

      } catch (err) {
        showAlert('alertList', 'error', 'ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
        tbody.innerHTML = '<tr><td colspan="10" class="loading">ì˜¤ë¥˜ ë°œìƒ</td></tr>';
      }
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats(data) {
      document.getElementById('totalAccounts').textContent = data.length;
      document.getElementById('activeAccounts').textContent = data.filter(a => a.status === 'active').length;
      document.getElementById('todayCafePosts').textContent = data.reduce((sum, a) => sum + (a.today_cafe_count || 0), 0);
      document.getElementById('todayBlogPosts').textContent = data.reduce((sum, a) => sum + (a.today_blog_count || 0), 0);
    }

    // ë¹„ë°€ë²ˆí˜¸ í† ê¸€
    function togglePw(el, pw) {
      el.textContent = el.textContent === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' ? pw : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
    }

    // ê³„ì • ì¶”ê°€
    async function addAccount() {
      const naverId = document.getElementById('naverId').value.trim();
      const naverPw = document.getElementById('naverPw').value.trim();

      if (!naverId || !naverPw) {
        showAlert('alertAdd', 'error', 'IDì™€ ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
      }

      try {
        const res = await fetch('/api/accounts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            naver_id: naverId,
            naver_pw: naverPw,
            blog_id: document.getElementById('blogId').value.trim() || naverId,
            cafe_url: document.getElementById('cafeUrl').value.trim(),
            daily_cafe_limit: parseInt(document.getElementById('dailyCafeLimit').value) || 150,
            daily_blog_limit: parseInt(document.getElementById('dailyBlogLimit').value) ?? 5,
            memo: document.getElementById('memo').value.trim()
          })
        });

        const result = await res.json();
        if (!result.success) throw new Error(result.error);

        showAlert('alertAdd', 'success', `âœ… ê³„ì • ë“±ë¡ ì™„ë£Œ! (ID: ${result.data.id})`);

        // í¼ ì´ˆê¸°í™”
        document.getElementById('naverId').value = '';
        document.getElementById('naverPw').value = '';
        document.getElementById('blogId').value = '';
        document.getElementById('cafeUrl').value = '';
        document.getElementById('memo').value = '';

        loadAccounts();

      } catch (err) {
        showAlert('alertAdd', 'error', 'ì¶”ê°€ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // ìƒíƒœ ë³€ê²½
    async function toggleStatus(id, newStatus) {
      try {
        const res = await fetch(`/api/accounts/${id}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });

        const result = await res.json();
        if (!result.success) throw new Error(result.error);
        loadAccounts();
      } catch (err) {
        alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // ê³„ì • ì‚­ì œ
    async function deleteAccount(id, naverId) {
      if (!confirm(`ì •ë§ "${naverId}" ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        const res = await fetch(`/api/accounts/${id}`, { method: 'DELETE' });
        const result = await res.json();
        if (!result.success) throw new Error(result.error);
        loadAccounts();
      } catch (err) {
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // ì•Œë¦¼ í‘œì‹œ
    function showAlert(elementId, type, message) {
      const el = document.getElementById(elementId);
      el.className = `alert alert-${type}`;
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 5000);
    }

    // ê²Œì‹œ íšŸìˆ˜ ìˆ˜ì •
    function editCount(el, accountId, type, currentValue) {
      // ì´ë¯¸ inputì´ ìˆìœ¼ë©´ ë¬´ì‹œ
      if (el.querySelector('input')) return;

      const originalValue = currentValue;
      const input = document.createElement('input');
      input.type = 'number';
      input.value = currentValue;
      input.min = 0;
      input.max = 999;
      input.dataset.accountId = accountId;
      input.dataset.type = type;
      input.dataset.originalValue = originalValue;

      el.textContent = '';
      el.appendChild(input);
      input.focus();
      input.select();

      // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      input.addEventListener('blur', handleCountBlur);
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          this.blur();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          this.parentElement.textContent = this.dataset.originalValue;
        }
      });
    }

    // blur í•¸ë“¤ëŸ¬
    async function handleCountBlur(e) {
      const input = e.target;
      const accountId = input.dataset.accountId;
      const field = input.dataset.type;
      const originalValue = input.dataset.originalValue;
      const newValue = parseInt(input.value) || 0;
      const parentEl = input.parentElement;

      // ê°’ì´ ê°™ìœ¼ë©´ ì›ë³µ
      if (newValue == originalValue) {
        parentEl.textContent = originalValue;
        return;
      }

      try {
        const body = { [field]: newValue };

        const res = await fetch(`/api/accounts/${accountId}/counts`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const result = await res.json();
        if (!result.success) throw new Error(result.error);

        // ì„±ê³µ
        parentEl.textContent = newValue;
        const labels = {
          today_cafe_count: 'ì¹´í˜ ê²Œì‹œ íšŸìˆ˜',
          today_blog_count: 'ë¸”ë¡œê·¸ ê²Œì‹œ íšŸìˆ˜',
          daily_cafe_limit: 'ì¹´í˜ ì¼ì¼ ì œí•œ',
          daily_blog_limit: 'ë¸”ë¡œê·¸ ì¼ì¼ ì œí•œ'
        };
        showAlert('alertList', 'success', `âœ… ${labels[field]}ê°€ ${newValue}ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);

        // í†µê³„ ê°±ì‹ 
        loadAccounts();

      } catch (err) {
        alert('ìˆ˜ì • ì‹¤íŒ¨: ' + err.message);
        parentEl.textContent = originalValue;
      }
    }

    // ì „ì—­ ë…¸ì¶œ
    window.loadAccounts = loadAccounts;
    window.addAccount = addAccount;
    window.toggleStatus = toggleStatus;
    window.deleteAccount = deleteAccount;
    window.togglePw = togglePw;
    window.editCount = editCount;
  </script>
</body>
</html>
