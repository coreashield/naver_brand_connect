<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë„¤ì´ë²„ ê³„ì • ê´€ë¦¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .card h2 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    /* í†µê³„ ì¹´ë“œ */
    .stats {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stat-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      min-width: 130px;
      text-align: center;
      transition: transform 0.2s;
    }

    .stat-box:hover {
      transform: translateY(-2px);
    }

    .stat-box .number {
      font-size: 28px;
      font-weight: bold;
    }

    .stat-box .label {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 4px;
    }

    .stat-box.green {
      background: linear-gradient(135deg, #2ed573 0%, #1e90ff 100%);
    }

    .stat-box.orange {
      background: linear-gradient(135deg, #ffa502 0%, #ff6348 100%);
    }

    .stat-box.red {
      background: linear-gradient(135deg, #ff4757 0%, #c44569 100%);
    }

    .stat-box.gray {
      background: linear-gradient(135deg, #747d8c 0%, #57606f 100%);
    }

    /* íƒ­ ìŠ¤íƒ€ì¼ */
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 0;
      background: #f8f9fa;
      border-radius: 12px 12px 0 0;
      overflow: hidden;
    }

    .tab {
      padding: 14px 28px;
      cursor: pointer;
      border: none;
      background: transparent;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 3px solid transparent;
    }

    .tab:hover {
      background: #e8f0fe;
      color: #667eea;
    }

    .tab.active {
      background: white;
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab .count {
      background: #e0e0e0;
      color: #666;
      border-radius: 12px;
      padding: 2px 10px;
      font-size: 12px;
      font-weight: bold;
    }

    .tab.active .count {
      background: #667eea;
      color: white;
    }

    .tab-content {
      background: white;
      border-radius: 0 0 16px 16px;
      padding: 24px;
    }

    /* í¼ */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .form-group input {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-danger { background: #ff4757; color: white; }
    .btn-danger:hover { background: #ff3344; }
    .btn-success { background: #2ed573; color: white; }
    .btn-warning { background: #ffa502; color: white; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-xs { padding: 4px 8px; font-size: 11px; }

    /* í…Œì´ë¸” */
    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
      font-size: 13px;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
      white-space: nowrap;
    }

    tr:hover {
      background: #f8f9fa;
    }

    /* ê³„ì • ì…€ ìŠ¤íƒ€ì¼ */
    .account-cell {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .account-id {
      font-weight: bold;
      color: #333;
      cursor: pointer;
      transition: color 0.2s;
    }

    .account-id:hover {
      color: #667eea;
    }

    .account-no {
      color: #667eea;
      font-size: 11px;
      font-weight: 600;
      margin-right: 4px;
      opacity: 0.8;
    }

    .account-blog {
      font-size: 11px;
      color: #888;
    }

    /* ì¹´í˜ ì…€ ìŠ¤íƒ€ì¼ */
    .cafe-cell {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .cafe-alias {
      color: #667eea;
      cursor: pointer;
      font-weight: 500;
    }

    .cafe-alias:hover {
      text-decoration: underline;
    }

    .cafe-url-hint {
      font-size: 10px;
      color: #aaa;
      cursor: pointer;
    }

    .cafe-url-hint:hover {
      color: #667eea;
    }

    /* ì§„í–‰ë¥  ë°” */
    .progress-cell {
      min-width: 160px;
    }

    .progress-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .progress-row:last-child {
      margin-bottom: 0;
    }

    .progress-label {
      font-size: 10px;
      color: #888;
      width: 35px;
      flex-shrink: 0;
    }

    .progress-bar {
      flex: 1;
      height: 8px;
      border-radius: 4px;
      background: #e0e0e0;
      overflow: hidden;
      min-width: 60px;
    }

    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s, background-color 0.3s;
    }

    .progress-fill.low { background: linear-gradient(90deg, #2ed573, #7bed9f); }
    .progress-fill.mid { background: linear-gradient(90deg, #ffa502, #eccc68); }
    .progress-fill.high { background: linear-gradient(90deg, #ff4757, #ff6b81); }

    .progress-text {
      font-size: 11px;
      color: #666;
      min-width: 55px;
      text-align: right;
      cursor: pointer;
    }

    .progress-text:hover {
      color: #667eea;
      font-weight: bold;
    }

    /* ìƒíƒœ ì•„ì´ì½˜ */
    .status-icon {
      font-size: 18px;
      text-align: center;
    }

    /* ì•¡ì…˜ ë²„íŠ¼ */
    .actions {
      display: flex;
      gap: 4px;
      white-space: nowrap;
    }

    /* ì•Œë¦¼ */
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: none;
      font-size: 14px;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    /* ìˆ˜ì • ëª¨ë“œ */
    .editing-row {
      background: #fff3cd !important;
    }

    .card.edit-mode {
      border: 3px solid #ffa502;
    }

    .card.edit-mode h2 {
      color: #ffa502;
    }

    /* ì¸ë¼ì¸ í¸ì§‘ */
    .inline-input {
      width: 50px;
      padding: 4px;
      border: 2px solid #667eea;
      border-radius: 4px;
      font-size: 12px;
      text-align: center;
    }

    /* ë©”ëª¨ ì…€ */
    .memo-cell {
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #888;
      font-size: 12px;
      cursor: help;
    }

    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state-text {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .empty-state-hint {
      font-size: 13px;
      color: #aaa;
    }

    /* íˆ´íŒ */
    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      white-space: nowrap;
      z-index: 1000;
      margin-bottom: 5px;
    }

    /* í—¤ë” ì•¡ì…˜ */
    .header-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .header-actions h2 {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    @media (max-width: 768px) {
      .form-grid { grid-template-columns: 1fr; }
      .stats { justify-content: center; }
      .tabs { flex-wrap: wrap; }
      .tab { flex: 1; justify-content: center; min-width: 120px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” ë„¤ì´ë²„ ê³„ì • ê´€ë¦¬</h1>

    <!-- í†µê³„ -->
    <div class="stats">
      <div class="stat-box">
        <div class="number" id="totalAccounts">-</div>
        <div class="label">ì „ì²´ ê³„ì •</div>
      </div>
      <div class="stat-box green">
        <div class="number" id="activeAccounts">-</div>
        <div class="label">í™œì„± ê³„ì •</div>
      </div>
      <div class="stat-box gray">
        <div class="number" id="suspendedAccounts">-</div>
        <div class="label">ë¹„í™œì„± ê³„ì •</div>
      </div>
      <div class="stat-box orange">
        <div class="number" id="todayCafePosts">-</div>
        <div class="label">ì˜¤ëŠ˜ ì¹´í˜</div>
      </div>
      <div class="stat-box red">
        <div class="number" id="todayBlogPosts">-</div>
        <div class="label">ì˜¤ëŠ˜ ë¸”ë¡œê·¸</div>
      </div>
    </div>

    <!-- ê³„ì • ì¶”ê°€/ìˆ˜ì • -->
    <div class="card" id="formCard">
      <h2 id="formTitle">â• ìƒˆ ê³„ì • ì¶”ê°€</h2>
      <div id="alertAdd" class="alert"></div>
      <input type="hidden" id="editingId" value="">
      <div class="form-grid">
        <div class="form-group">
          <label>ë„¤ì´ë²„ ID *</label>
          <input type="text" id="naverId" placeholder="example123">
        </div>
        <div class="form-group">
          <label>ë¹„ë°€ë²ˆí˜¸ *</label>
          <input type="password" id="naverPw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <div class="form-group">
          <label>ë¸”ë¡œê·¸ ID</label>
          <input type="text" id="blogId" placeholder="ë„¤ì´ë²„ IDì™€ ë™ì¼ ì‹œ ë¹„ì›Œë‘ì„¸ìš”">
        </div>
        <div class="form-group">
          <label>ì¹´í˜ ê¸€ì“°ê¸° URL</label>
          <input type="text" id="cafeUrl" placeholder="https://cafe.naver.com/...">
        </div>
        <div class="form-group">
          <label>ì¹´í˜ ë³„ì¹­ (ê°€ì…ìš©)</label>
          <input type="text" id="cafeAlias" placeholder="todaydeuktem">
        </div>
        <div class="form-group">
          <label>ì¼ì¼ ì¹´í˜ ì œí•œ</label>
          <input type="number" id="dailyCafeLimit" value="150">
        </div>
        <div class="form-group">
          <label>ì¼ì¼ ë¸”ë¡œê·¸ ì œí•œ</label>
          <input type="number" id="dailyBlogLimit" value="5">
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label>ë©”ëª¨</label>
          <input type="text" id="memo" placeholder="ê³„ì •ì— ëŒ€í•œ ë©”ëª¨">
        </div>
      </div>
      <div id="formButtons">
        <button class="btn btn-primary" id="btnAdd" onclick="addAccount()">ê³„ì • ì¶”ê°€</button>
        <button class="btn btn-success" id="btnUpdate" onclick="updateAccount()" style="display:none;">ìˆ˜ì • ì €ì¥</button>
        <button class="btn btn-primary" id="btnSaveNew" onclick="saveAsNew()" style="display:none;">ìƒˆë¡œ ì €ì¥</button>
        <button class="btn btn-danger" id="btnCancel" onclick="cancelEdit()" style="display:none;">ì·¨ì†Œ</button>
      </div>
    </div>

    <!-- ê³„ì • ëª©ë¡ -->
    <div class="card" style="padding: 0; overflow: hidden;">
      <!-- íƒ­ -->
      <div class="tabs">
        <button class="tab active" data-status="active" onclick="switchTab('active')">
          âœ… í™œì„± ê³„ì • <span class="count" id="tabActiveCount">0</span>
        </button>
        <button class="tab" data-status="suspended" onclick="switchTab('suspended')">
          â›” ë¹„í™œì„± ê³„ì • <span class="count" id="tabSuspendedCount">0</span>
        </button>
      </div>

      <!-- íƒ­ ì½˜í…ì¸  -->
      <div class="tab-content">
        <div class="header-actions">
          <h2 id="tableTitle">ğŸ“‹ í™œì„± ê³„ì • ëª©ë¡</h2>
          <button class="btn btn-sm btn-primary" onclick="loadAccounts()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div id="alertList" class="alert"></div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th style="width:40px; text-align:center;">âš¡</th>
                <th>ê³„ì •</th>
                <th>ì¹´í˜</th>
                <th>ì˜¤ëŠ˜ í¬ìŠ¤íŒ…</th>
                <th style="width:90px;">ìµœê·¼ ë¦¬ì…‹</th>
                <th style="width:100px;">ë©”ëª¨</th>
                <th style="width:100px;"></th>
              </tr>
            </thead>
            <tbody id="accountsTable">
              <tr><td colspan="7" class="loading">ë¡œë”© ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // í˜„ì¬ íƒ­ ìƒíƒœ
    let currentTab = 'active';
    let allAccountsData = []; // ì „ì²´ ë°ì´í„° ìºì‹œ

    // í˜ì´ì§€ ë¡œë“œ ì‹œ
    document.addEventListener('DOMContentLoaded', () => {
      // URL íŒŒë¼ë¯¸í„°ë¡œ íƒ­ ìƒíƒœ ë³µì›
      const params = new URLSearchParams(window.location.search);
      const tabParam = params.get('tab');
      if (tabParam && ['active', 'suspended'].includes(tabParam)) {
        currentTab = tabParam;
      }
      loadAccounts();
    });

    // íƒ­ ì „í™˜
    function switchTab(status) {
      currentTab = status;

      // URL ì—…ë°ì´íŠ¸
      const url = new URL(window.location);
      url.searchParams.set('tab', status);
      window.history.replaceState({}, '', url);

      // íƒ­ UI ì—…ë°ì´íŠ¸
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.status === status);
      });

      // ì œëª© ì—…ë°ì´íŠ¸
      document.getElementById('tableTitle').textContent =
        status === 'active' ? 'ğŸ“‹ í™œì„± ê³„ì • ëª©ë¡' : 'ğŸ“‹ ë¹„í™œì„± ê³„ì • ëª©ë¡';

      // í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§
      renderTable(allAccountsData.filter(acc =>
        status === 'active' ? acc.status === 'active' : acc.status === 'suspended'
      ));
    }

    // ë¦¬ì…‹ ë‚ ì§œ í¬ë§·
    function formatResetDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      const now = new Date();
      const isToday = date.toDateString() === now.toDateString();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const mins = String(date.getMinutes()).padStart(2, '0');
      if (isToday) {
        return `ì˜¤ëŠ˜ ${hours}:${mins}`;
      }
      return `${month}/${day} ${hours}:${mins}`;
    }

    // ì§„í–‰ë¥  ê³„ì‚° ë° í´ë˜ìŠ¤ ê²°ì •
    function getProgressClass(current, limit) {
      const percent = limit > 0 ? (current / limit) * 100 : 0;
      if (percent >= 80) return 'high';
      if (percent >= 50) return 'mid';
      return 'low';
    }

    // í´ë¦½ë³´ë“œ ë³µì‚¬
    function copyToClipboard(text, successMsg = 'í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤') {
      if (!text || text === '-') return;
      navigator.clipboard.writeText(text).then(() => {
        showAlert('alertList', 'success', `ğŸ“‹ ${successMsg}`);
      });
    }

    // ê³„ì • ëª©ë¡ ë¡œë“œ
    async function loadAccounts() {
      const tbody = document.getElementById('accountsTable');
      tbody.innerHTML = '<tr><td colspan="7" class="loading">ë¡œë”© ì¤‘...</td></tr>';

      try {
        // ì „ì²´ ë°ì´í„° ë¡œë“œ (í•„í„° ì—†ì´)
        const res = await fetch('/api/accounts');
        const result = await res.json();

        if (!result.success) throw new Error(result.error);

        allAccountsData = result.data || [];

        // íƒ­ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        const activeCount = allAccountsData.filter(a => a.status === 'active').length;
        const suspendedCount = allAccountsData.filter(a => a.status === 'suspended').length;
        document.getElementById('tabActiveCount').textContent = activeCount;
        document.getElementById('tabSuspendedCount').textContent = suspendedCount;

        // í†µê³„ ì—…ë°ì´íŠ¸
        updateStats(allAccountsData);

        // í˜„ì¬ íƒ­ì— ë§ëŠ” ë°ì´í„°ë§Œ ë Œë”ë§
        const filteredData = allAccountsData.filter(acc =>
          currentTab === 'active' ? acc.status === 'active' : acc.status === 'suspended'
        );

        renderTable(filteredData);

      } catch (err) {
        showAlert('alertList', 'error', 'ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
        tbody.innerHTML = '<tr><td colspan="7" class="loading">ì˜¤ë¥˜ ë°œìƒ</td></tr>';
      }
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable(data) {
      const tbody = document.getElementById('accountsTable');

      if (!data || data.length === 0) {
        const emptyMsg = currentTab === 'active'
          ? { icon: 'âœ¨', text: 'í™œì„± ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤', hint: 'ìƒˆ ê³„ì •ì„ ì¶”ê°€í•˜ê±°ë‚˜ ë¹„í™œì„± ê³„ì •ì„ í™œì„±í™”í•˜ì„¸ìš”' }
          : { icon: 'ğŸ˜´', text: 'ë¹„í™œì„± ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤', hint: 'ëª¨ë“  ê³„ì •ì´ í™œì„± ìƒíƒœì…ë‹ˆë‹¤' };

        tbody.innerHTML = `
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <div class="empty-state-icon">${emptyMsg.icon}</div>
                <div class="empty-state-text">${emptyMsg.text}</div>
                <div class="empty-state-hint">${emptyMsg.hint}</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = data.map(acc => {
        const cafePercent = acc.daily_cafe_limit > 0 ? Math.min(100, (acc.today_cafe_count / acc.daily_cafe_limit) * 100) : 0;
        const blogPercent = acc.daily_blog_limit > 0 ? Math.min(100, (acc.today_blog_count / acc.daily_blog_limit) * 100) : 0;
        const cafeClass = getProgressClass(acc.today_cafe_count, acc.daily_cafe_limit);
        const blogClass = getProgressClass(acc.today_blog_count, acc.daily_blog_limit);

        return `
          <tr data-id="${acc.id}">
            <td class="status-icon">${acc.status === 'active' ? 'âœ…' : 'â›”'}</td>
            <td>
              <div class="account-cell">
                <span class="account-id" onclick="loadAccountToForm(${acc.id})" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •"><span class="account-no">#${acc.id}</span>${acc.naver_id}</span>
                <span class="account-blog">${acc.blog_id && acc.blog_id !== acc.naver_id ? `ğŸ“ ${acc.blog_id}` : ''}</span>
              </div>
            </td>
            <td>
              <div class="cafe-cell">
                ${acc.cafe_alias
                  ? `<span class="cafe-alias" onclick="goToCafe('${acc.cafe_alias}')" title="í´ë¦­í•˜ì—¬ ì¹´í˜ ì´ë™">${acc.cafe_alias}</span>`
                  : '<span style="color:#ccc;">-</span>'
                }
                ${acc.cafe_url
                  ? `<span class="cafe-url-hint" onclick="copyToClipboard('${acc.cafe_url}', 'URL ë³µì‚¬ë¨')" title="${acc.cafe_url}">URL ë³µì‚¬</span>`
                  : ''
                }
              </div>
            </td>
            <td class="progress-cell">
              <div class="progress-row">
                <span class="progress-label">ì¹´í˜</span>
                <div class="progress-bar">
                  <div class="progress-fill ${cafeClass}" style="width: ${cafePercent}%;"></div>
                </div>
                <span class="progress-text" onclick="editProgress(this, ${acc.id}, 'cafe', ${acc.today_cafe_count}, ${acc.daily_cafe_limit})" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •">
                  ${acc.today_cafe_count}/${acc.daily_cafe_limit}
                </span>
              </div>
              <div class="progress-row">
                <span class="progress-label">ë¸”ë¡œê·¸</span>
                <div class="progress-bar">
                  <div class="progress-fill ${blogClass}" style="width: ${blogPercent}%;"></div>
                </div>
                <span class="progress-text" onclick="editProgress(this, ${acc.id}, 'blog', ${acc.today_blog_count}, ${acc.daily_blog_limit})" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •">
                  ${acc.today_blog_count}/${acc.daily_blog_limit}
                </span>
              </div>
            </td>
            <td style="font-size:11px; color:#666;">${formatResetDate(acc.last_reset_date)}</td>
            <td class="memo-cell" title="${acc.memo || ''}">${acc.memo || '-'}</td>
            <td class="actions">
              ${acc.status === 'active'
                ? `<button class="btn btn-warning btn-xs" onclick="toggleStatus(${acc.id}, 'suspended')">ì¤‘ì§€</button>`
                : `<button class="btn btn-success btn-xs" onclick="toggleStatus(${acc.id}, 'active')">í™œì„±</button>`
              }
              <button class="btn btn-danger btn-xs" onclick="deleteAccount(${acc.id}, '${acc.naver_id}')">ì‚­ì œ</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats(data) {
      const activeData = data.filter(a => a.status === 'active');
      const suspendedData = data.filter(a => a.status === 'suspended');

      document.getElementById('totalAccounts').textContent = data.length;
      document.getElementById('activeAccounts').textContent = activeData.length;
      document.getElementById('suspendedAccounts').textContent = suspendedData.length;

      // í™œì„± ê³„ì •ë§Œì˜ í¬ìŠ¤íŒ… í•©ê³„
      document.getElementById('todayCafePosts').textContent = activeData.reduce((sum, a) => sum + (a.today_cafe_count || 0), 0);
      document.getElementById('todayBlogPosts').textContent = activeData.reduce((sum, a) => sum + (a.today_blog_count || 0), 0);
    }

    // ê³„ì • ì¶”ê°€
    async function addAccount() {
      const naverId = document.getElementById('naverId').value.trim();
      const naverPw = document.getElementById('naverPw').value.trim();

      if (!naverId || !naverPw) {
        showAlert('alertAdd', 'error', 'IDì™€ ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
      }

      try {
        const res = await fetch('/api/accounts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            naver_id: naverId,
            naver_pw: naverPw,
            blog_id: document.getElementById('blogId').value.trim() || naverId,
            cafe_url: document.getElementById('cafeUrl').value.trim(),
            cafe_alias: document.getElementById('cafeAlias').value.trim(),
            daily_cafe_limit: (v => isNaN(v) ? 150 : v)(parseInt(document.getElementById('dailyCafeLimit').value)),
            daily_blog_limit: (v => isNaN(v) ? 5 : v)(parseInt(document.getElementById('dailyBlogLimit').value)),
            memo: document.getElementById('memo').value.trim()
          })
        });

        const result = await res.json();
        if (!result.success) throw new Error(result.error);

        showAlert('alertAdd', 'success', `âœ… ê³„ì • ë“±ë¡ ì™„ë£Œ! (ID: ${result.data.id})`);
        clearForm();
        loadAccounts();

      } catch (err) {
        showAlert('alertAdd', 'error', 'ì¶”ê°€ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // ìƒíƒœ ë³€ê²½
    async function toggleStatus(id, newStatus) {
      try {
        const res = await fetch(`/api/accounts/${id}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });

        const result = await res.json();
        if (!result.success) throw new Error(result.error);

        // íƒ­ ìë™ ì „í™˜ (ìƒíƒœ ë³€ê²½ ì‹œ í•´ë‹¹ íƒ­ìœ¼ë¡œ ì´ë™)
        if (newStatus !== currentTab) {
          switchTab(newStatus);
        }

        loadAccounts();
        showAlert('alertList', 'success', `âœ… ê³„ì • ìƒíƒœê°€ ${newStatus === 'active' ? 'í™œì„±' : 'ë¹„í™œì„±'}ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      } catch (err) {
        alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // ê³„ì • ì‚­ì œ
    async function deleteAccount(id, naverId) {
      if (!confirm(`ì •ë§ "${naverId}" ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        const res = await fetch(`/api/accounts/${id}`, { method: 'DELETE' });
        const result = await res.json();
        if (!result.success) throw new Error(result.error);
        loadAccounts();
        showAlert('alertList', 'success', `ğŸ—‘ï¸ "${naverId}" ê³„ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
      } catch (err) {
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // ì•Œë¦¼ í‘œì‹œ
    function showAlert(elementId, type, message) {
      const el = document.getElementById(elementId);
      el.className = `alert alert-${type}`;
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 4000);
    }

    // ì§„í–‰ë¥  í¸ì§‘ (ê°„ì†Œí™”ëœ ì¸ë¼ì¸ ìˆ˜ì •)
    function editProgress(el, accountId, type, currentCount, currentLimit) {
      // ì´ë¯¸ í¸ì§‘ ì¤‘ì´ë©´ ë¬´ì‹œ
      if (el.querySelector('input')) return;

      const countField = type === 'cafe' ? 'today_cafe_count' : 'today_blog_count';
      const limitField = type === 'cafe' ? 'daily_cafe_limit' : 'daily_blog_limit';
      const originalText = el.textContent;

      el.innerHTML = `
        <input class="inline-input" type="number" value="${currentCount}" min="0" max="999" id="edit-count-${accountId}">
        /
        <input class="inline-input" type="number" value="${currentLimit}" min="1" max="999" id="edit-limit-${accountId}">
      `;

      const countInput = document.getElementById(`edit-count-${accountId}`);
      const limitInput = document.getElementById(`edit-limit-${accountId}`);
      countInput.focus();
      countInput.select();

      // ì €ì¥ í•¨ìˆ˜
      async function saveProgress() {
        const newCount = parseInt(countInput.value) || 0;
        const newLimit = parseInt(limitInput.value) || (type === 'cafe' ? 150 : 5);

        if (newCount === currentCount && newLimit === currentLimit) {
          el.textContent = originalText;
          return;
        }

        try {
          const res = await fetch(`/api/accounts/${accountId}/counts`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              [countField]: newCount,
              [limitField]: newLimit
            })
          });

          const result = await res.json();
          if (!result.success) throw new Error(result.error);

          showAlert('alertList', 'success', `âœ… ${type === 'cafe' ? 'ì¹´í˜' : 'ë¸”ë¡œê·¸'} ìˆ˜ì¹˜ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          loadAccounts();
        } catch (err) {
          alert('ìˆ˜ì • ì‹¤íŒ¨: ' + err.message);
          el.textContent = originalText;
        }
      }

      // ì´ë²¤íŠ¸
      [countInput, limitInput].forEach(input => {
        input.addEventListener('blur', function(e) {
          // ë‹¤ë¥¸ inputìœ¼ë¡œ ì´ë™í•˜ëŠ” ê²½ìš°ëŠ” ì €ì¥í•˜ì§€ ì•ŠìŒ
          setTimeout(() => {
            if (!el.contains(document.activeElement)) {
              saveProgress();
            }
          }, 100);
        });
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            saveProgress();
          } else if (e.key === 'Escape') {
            e.preventDefault();
            el.textContent = originalText;
          }
        });
      });
    }

    // ì¹´í˜ ë§í¬ë¡œ ì´ë™
    function goToCafe(alias) {
      if (!alias || alias === '-') {
        showAlert('alertList', 'error', 'ì¹´í˜ ë³„ì¹­ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }
      window.open(`https://cafe.naver.com/${alias}`, '_blank');
    }

    // ê³„ì • ì •ë³´ë¥¼ í¼ì— ë¡œë“œ (ìˆ˜ì • ëª¨ë“œ)
    function loadAccountToForm(accountId) {
      const acc = allAccountsData.find(a => a.id === accountId);
      if (!acc) {
        alert('ê³„ì • ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
      document.getElementById('editingId').value = acc.id;
      document.getElementById('naverId').value = acc.naver_id;
      document.getElementById('naverId').disabled = true;
      document.getElementById('naverPw').value = acc.naver_pw;
      document.getElementById('blogId').value = acc.blog_id || '';
      document.getElementById('cafeUrl').value = acc.cafe_url || '';
      document.getElementById('cafeAlias').value = acc.cafe_alias || '';
      document.getElementById('dailyCafeLimit').value = acc.daily_cafe_limit ?? 150;
      document.getElementById('dailyBlogLimit').value = acc.daily_blog_limit ?? 5;
      document.getElementById('memo').value = acc.memo || '';

      // UI ë³€ê²½ - ìˆ˜ì • ëª¨ë“œ
      document.getElementById('formTitle').textContent = `âœï¸ ê³„ì • ìˆ˜ì •: ${acc.naver_id}`;
      document.getElementById('formCard').classList.add('edit-mode');
      document.getElementById('btnAdd').style.display = 'none';
      document.getElementById('btnUpdate').style.display = 'inline-block';
      document.getElementById('btnSaveNew').style.display = 'inline-block';
      document.getElementById('btnCancel').style.display = 'inline-block';

      // í…Œì´ë¸”ì—ì„œ í•´ë‹¹ í–‰ í•˜ì´ë¼ì´íŠ¸
      document.querySelectorAll('#accountsTable tr').forEach(tr => tr.classList.remove('editing-row'));
      document.querySelector(`#accountsTable tr[data-id="${accountId}"]`)?.classList.add('editing-row');

      // í¼ìœ¼ë¡œ ìŠ¤í¬ë¡¤
      document.getElementById('formCard').scrollIntoView({ behavior: 'smooth', block: 'start' });

      showAlert('alertAdd', 'success', `ğŸ“ "${acc.naver_id}" ê³„ì • ì •ë³´ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    // ê³„ì • ìˆ˜ì • ì €ì¥
    async function updateAccount() {
      const editingId = document.getElementById('editingId').value;
      if (!editingId) {
        alert('ìˆ˜ì •í•  ê³„ì •ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }

      const naverPw = document.getElementById('naverPw').value.trim();
      if (!naverPw) {
        showAlert('alertAdd', 'error', 'ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
      }

      try {
        const res = await fetch(`/api/accounts/${editingId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            naver_pw: naverPw,
            blog_id: document.getElementById('blogId').value.trim() || null,
            cafe_url: document.getElementById('cafeUrl').value.trim() || null,
            cafe_alias: document.getElementById('cafeAlias').value.trim() || null,
            daily_cafe_limit: (v => isNaN(v) ? 150 : v)(parseInt(document.getElementById('dailyCafeLimit').value)),
            daily_blog_limit: (v => isNaN(v) ? 5 : v)(parseInt(document.getElementById('dailyBlogLimit').value)),
            memo: document.getElementById('memo').value.trim() || null
          })
        });

        const result = await res.json();
        if (!result.success) throw new Error(result.error);

        showAlert('alertAdd', 'success', 'âœ… ê³„ì • ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
        cancelEdit();
        loadAccounts();

      } catch (err) {
        showAlert('alertAdd', 'error', 'ìˆ˜ì • ì‹¤íŒ¨: ' + err.message);
      }
    }

    // í¼ ì´ˆê¸°í™”
    function clearForm() {
      document.getElementById('naverId').value = '';
      document.getElementById('naverPw').value = '';
      document.getElementById('blogId').value = '';
      document.getElementById('cafeUrl').value = '';
      document.getElementById('cafeAlias').value = '';
      document.getElementById('dailyCafeLimit').value = '150';
      document.getElementById('dailyBlogLimit').value = '5';
      document.getElementById('memo').value = '';
    }

    // ìˆ˜ì • ì·¨ì†Œ
    function cancelEdit() {
      document.getElementById('editingId').value = '';
      document.getElementById('naverId').disabled = false;
      clearForm();

      // UI ë³€ê²½ - ì¶”ê°€ ëª¨ë“œ
      document.getElementById('formTitle').textContent = 'â• ìƒˆ ê³„ì • ì¶”ê°€';
      document.getElementById('formCard').classList.remove('edit-mode');
      document.getElementById('btnAdd').style.display = 'inline-block';
      document.getElementById('btnUpdate').style.display = 'none';
      document.getElementById('btnSaveNew').style.display = 'none';
      document.getElementById('btnCancel').style.display = 'none';

      // í…Œì´ë¸” í•˜ì´ë¼ì´íŠ¸ ì œê±°
      document.querySelectorAll('#accountsTable tr').forEach(tr => tr.classList.remove('editing-row'));
    }

    // ìƒˆë¡œ ì €ì¥
    function saveAsNew() {
      document.getElementById('naverId').disabled = false;
      document.getElementById('naverId').focus();
      document.getElementById('naverId').select();
      document.getElementById('editingId').value = '';

      document.getElementById('formTitle').textContent = 'â• ìƒˆ ê³„ì •ìœ¼ë¡œ ì €ì¥ (ID ìˆ˜ì • í›„ ì¶”ê°€)';
      document.getElementById('formCard').classList.remove('edit-mode');
      document.getElementById('btnUpdate').style.display = 'none';
      document.getElementById('btnSaveNew').style.display = 'none';
      document.getElementById('btnAdd').style.display = 'inline-block';

      document.querySelectorAll('#accountsTable tr').forEach(tr => tr.classList.remove('editing-row'));
      showAlert('alertAdd', 'success', 'ğŸ“ IDë¥¼ ìƒˆë¡œìš´ ê°’ìœ¼ë¡œ ë³€ê²½ í›„ "ê³„ì • ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
    }

    // ì „ì—­ ë…¸ì¶œ
    window.loadAccounts = loadAccounts;
    window.addAccount = addAccount;
    window.toggleStatus = toggleStatus;
    window.deleteAccount = deleteAccount;
    window.editProgress = editProgress;
    window.goToCafe = goToCafe;
    window.loadAccountToForm = loadAccountToForm;
    window.updateAccount = updateAccount;
    window.cancelEdit = cancelEdit;
    window.saveAsNew = saveAsNew;
    window.switchTab = switchTab;
    window.copyToClipboard = copyToClipboard;
  </script>
</body>
</html>
